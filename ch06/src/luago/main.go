package main

import (
	"fmt"
	"io/ioutil"
	. "luago/api"
	"luago/binchunk"
	"luago/state"
	. "luago/vm"
	"os"
)

func main() {
	if len(os.Args) > 1 {
		data, err := ioutil.ReadFile(os.Args[1])
		if err != nil {
			panic(err)
		}
		proto := binchunk.Undump(data)
		luaMain(proto)
	}
}

func luaMain(proto *binchunk.Prototype) {
	nRegs := int(proto.MaxStackSize)
	ls := state.New(nRegs+8, proto)
	ls.SetTop(nRegs)
	for {
		pc := ls.PC()
		inst := Instruction(ls.Fetch())
		if inst.Opcode() != OP_RETURN {
			inst.Execute(ls)
			fmt.Printf("[%02d] %s ", pc+1, inst.OpName())
			printStack(ls)
		} else {
			break
		}
	}
}

func printStack(ls LuaState) {
	top := ls.GetTop()
	for i := 1; i <= top; i++ {
		t := ls.Type(i)
		switch t {
		case LUA_TBOOLEAN:
			fmt.Printf("[%t]", ls.ToBoolean(i))
		case LUA_TNUMBER:
			fmt.Printf("[%g]", ls.ToNumber(i))
		case LUA_TSTRING:
			fmt.Printf("[%q]", ls.ToString(i))
		default:
			fmt.Printf("[%s]", ls.TypeName(t))
		}
	}
	fmt.Println()
}

/*
local sum = 0
for i=1, 100 do
    if i % 2 == 0 then
        sum = sum + i
    end
end
*/
/*
API server listening at: 127.0.0.1:5369

main <@move.lua:0, 0> (11 instructions)
0+ params, 6 slots, 1 upvalues, 5 locals, 4 constants, 0 functions
	1	[1]	LOADK    	0 -1
	2	[2]	LOADK    	1 -2
	3	[2]	LOADK    	2 -3
	4	[2]	LOADK    	3 -2
	5	[2]	FORPREP  	1 4
	6	[3]	MOD      	5 4 -4
	7	[3]	EQ       	0 5 -1
	8	[3]	JMP      	0 1
	9	[4]	ADD      	0 0 4
	10	[2]	FORLOOP  	1 -5
	11	[6]	RETURN   	0 1
constants (4):
	1	0
	2	1
	3	100
	4	2
locals (5):
	0	sum	2	12
	1	(for index)	5	11
	2	(for limit)	5	11
	3	(for step)	5	11
	4	i	6	10
upvalues (1)
	0	_ENV	1	0
Process exiting with code: 0

*/
/*
API server listening at: 127.0.0.1:17940
[01] LOADK    [0][nil][nil][nil][nil][nil]
[02] LOADK    [0][1][nil][nil][nil][nil]
[03] LOADK    [0][1][100][nil][nil][nil]
[04] LOADK    [0][1][100][1][nil][nil]
[05] FORPREP  [0][0][100][1][nil][nil]
[10] FORLOOP  [0][1][100][1][1][nil]
[06] MOD      [0][1][100][1][1][1]
[07] EQ       [0][1][100][1][1][1]
[08] JMP      [0][1][100][1][1][1]
[10] FORLOOP  [0][2][100][1][2][1]
[06] MOD      [0][2][100][1][2][0]
[07] EQ       [0][2][100][1][2][0]
[09] ADD      [2][2][100][1][2][0]
[10] FORLOOP  [2][3][100][1][3][0]
[06] MOD      [2][3][100][1][3][1]
[07] EQ       [2][3][100][1][3][1]
[08] JMP      [2][3][100][1][3][1]
[10] FORLOOP  [2][4][100][1][4][1]
[06] MOD      [2][4][100][1][4][0]
[07] EQ       [2][4][100][1][4][0]
[09] ADD      [6][4][100][1][4][0]
[10] FORLOOP  [6][5][100][1][5][0]
[06] MOD      [6][5][100][1][5][1]
[07] EQ       [6][5][100][1][5][1]
[08] JMP      [6][5][100][1][5][1]
[10] FORLOOP  [6][6][100][1][6][1]
[06] MOD      [6][6][100][1][6][0]
[07] EQ       [6][6][100][1][6][0]
[09] ADD      [12][6][100][1][6][0]
[10] FORLOOP  [12][7][100][1][7][0]
[06] MOD      [12][7][100][1][7][1]
[07] EQ       [12][7][100][1][7][1]
[08] JMP      [12][7][100][1][7][1]
[10] FORLOOP  [12][8][100][1][8][1]
[06] MOD      [12][8][100][1][8][0]
[07] EQ       [12][8][100][1][8][0]
[09] ADD      [20][8][100][1][8][0]
[10] FORLOOP  [20][9][100][1][9][0]
[06] MOD      [20][9][100][1][9][1]
[07] EQ       [20][9][100][1][9][1]
[08] JMP      [20][9][100][1][9][1]
[10] FORLOOP  [20][10][100][1][10][1]
[06] MOD      [20][10][100][1][10][0]
[07] EQ       [20][10][100][1][10][0]
[09] ADD      [30][10][100][1][10][0]
[10] FORLOOP  [30][11][100][1][11][0]
[06] MOD      [30][11][100][1][11][1]
[07] EQ       [30][11][100][1][11][1]
[08] JMP      [30][11][100][1][11][1]
[10] FORLOOP  [30][12][100][1][12][1]
[06] MOD      [30][12][100][1][12][0]
[07] EQ       [30][12][100][1][12][0]
[09] ADD      [42][12][100][1][12][0]
[10] FORLOOP  [42][13][100][1][13][0]
[06] MOD      [42][13][100][1][13][1]
[07] EQ       [42][13][100][1][13][1]
[08] JMP      [42][13][100][1][13][1]
[10] FORLOOP  [42][14][100][1][14][1]
[06] MOD      [42][14][100][1][14][0]
[07] EQ       [42][14][100][1][14][0]
[09] ADD      [56][14][100][1][14][0]
[10] FORLOOP  [56][15][100][1][15][0]
[06] MOD      [56][15][100][1][15][1]
[07] EQ       [56][15][100][1][15][1]
[08] JMP      [56][15][100][1][15][1]
[10] FORLOOP  [56][16][100][1][16][1]
[06] MOD      [56][16][100][1][16][0]
[07] EQ       [56][16][100][1][16][0]
[09] ADD      [72][16][100][1][16][0]
[10] FORLOOP  [72][17][100][1][17][0]
[06] MOD      [72][17][100][1][17][1]
[07] EQ       [72][17][100][1][17][1]
[08] JMP      [72][17][100][1][17][1]
[10] FORLOOP  [72][18][100][1][18][1]
[06] MOD      [72][18][100][1][18][0]
[07] EQ       [72][18][100][1][18][0]
[09] ADD      [90][18][100][1][18][0]
[10] FORLOOP  [90][19][100][1][19][0]
[06] MOD      [90][19][100][1][19][1]
[07] EQ       [90][19][100][1][19][1]
[08] JMP      [90][19][100][1][19][1]
[10] FORLOOP  [90][20][100][1][20][1]
[06] MOD      [90][20][100][1][20][0]
[07] EQ       [90][20][100][1][20][0]
[09] ADD      [110][20][100][1][20][0]
[10] FORLOOP  [110][21][100][1][21][0]
[06] MOD      [110][21][100][1][21][1]
[07] EQ       [110][21][100][1][21][1]
[08] JMP      [110][21][100][1][21][1]
[10] FORLOOP  [110][22][100][1][22][1]
[06] MOD      [110][22][100][1][22][0]
[07] EQ       [110][22][100][1][22][0]
[09] ADD      [132][22][100][1][22][0]
[10] FORLOOP  [132][23][100][1][23][0]
[06] MOD      [132][23][100][1][23][1]
[07] EQ       [132][23][100][1][23][1]
[08] JMP      [132][23][100][1][23][1]
[10] FORLOOP  [132][24][100][1][24][1]
[06] MOD      [132][24][100][1][24][0]
[07] EQ       [132][24][100][1][24][0]
[09] ADD      [156][24][100][1][24][0]
[10] FORLOOP  [156][25][100][1][25][0]
[06] MOD      [156][25][100][1][25][1]
[07] EQ       [156][25][100][1][25][1]
[08] JMP      [156][25][100][1][25][1]
[10] FORLOOP  [156][26][100][1][26][1]
[06] MOD      [156][26][100][1][26][0]
[07] EQ       [156][26][100][1][26][0]
[09] ADD      [182][26][100][1][26][0]
[10] FORLOOP  [182][27][100][1][27][0]
[06] MOD      [182][27][100][1][27][1]
[07] EQ       [182][27][100][1][27][1]
[08] JMP      [182][27][100][1][27][1]
[10] FORLOOP  [182][28][100][1][28][1]
[06] MOD      [182][28][100][1][28][0]
[07] EQ       [182][28][100][1][28][0]
[09] ADD      [210][28][100][1][28][0]
[10] FORLOOP  [210][29][100][1][29][0]
[06] MOD      [210][29][100][1][29][1]
[07] EQ       [210][29][100][1][29][1]
[08] JMP      [210][29][100][1][29][1]
[10] FORLOOP  [210][30][100][1][30][1]
[06] MOD      [210][30][100][1][30][0]
[07] EQ       [210][30][100][1][30][0]
[09] ADD      [240][30][100][1][30][0]
[10] FORLOOP  [240][31][100][1][31][0]
[06] MOD      [240][31][100][1][31][1]
[07] EQ       [240][31][100][1][31][1]
[08] JMP      [240][31][100][1][31][1]
[10] FORLOOP  [240][32][100][1][32][1]
[06] MOD      [240][32][100][1][32][0]
[07] EQ       [240][32][100][1][32][0]
[09] ADD      [272][32][100][1][32][0]
[10] FORLOOP  [272][33][100][1][33][0]
[06] MOD      [272][33][100][1][33][1]
[07] EQ       [272][33][100][1][33][1]
[08] JMP      [272][33][100][1][33][1]
[10] FORLOOP  [272][34][100][1][34][1]
[06] MOD      [272][34][100][1][34][0]
[07] EQ       [272][34][100][1][34][0]
[09] ADD      [306][34][100][1][34][0]
[10] FORLOOP  [306][35][100][1][35][0]
[06] MOD      [306][35][100][1][35][1]
[07] EQ       [306][35][100][1][35][1]
[08] JMP      [306][35][100][1][35][1]
[10] FORLOOP  [306][36][100][1][36][1]
[06] MOD      [306][36][100][1][36][0]
[07] EQ       [306][36][100][1][36][0]
[09] ADD      [342][36][100][1][36][0]
[10] FORLOOP  [342][37][100][1][37][0]
[06] MOD      [342][37][100][1][37][1]
[07] EQ       [342][37][100][1][37][1]
[08] JMP      [342][37][100][1][37][1]
[10] FORLOOP  [342][38][100][1][38][1]
[06] MOD      [342][38][100][1][38][0]
[07] EQ       [342][38][100][1][38][0]
[09] ADD      [380][38][100][1][38][0]
[10] FORLOOP  [380][39][100][1][39][0]
[06] MOD      [380][39][100][1][39][1]
[07] EQ       [380][39][100][1][39][1]
[08] JMP      [380][39][100][1][39][1]
[10] FORLOOP  [380][40][100][1][40][1]
[06] MOD      [380][40][100][1][40][0]
[07] EQ       [380][40][100][1][40][0]
[09] ADD      [420][40][100][1][40][0]
[10] FORLOOP  [420][41][100][1][41][0]
[06] MOD      [420][41][100][1][41][1]
[07] EQ       [420][41][100][1][41][1]
[08] JMP      [420][41][100][1][41][1]
[10] FORLOOP  [420][42][100][1][42][1]
[06] MOD      [420][42][100][1][42][0]
[07] EQ       [420][42][100][1][42][0]
[09] ADD      [462][42][100][1][42][0]
[10] FORLOOP  [462][43][100][1][43][0]
[06] MOD      [462][43][100][1][43][1]
[07] EQ       [462][43][100][1][43][1]
[08] JMP      [462][43][100][1][43][1]
[10] FORLOOP  [462][44][100][1][44][1]
[06] MOD      [462][44][100][1][44][0]
[07] EQ       [462][44][100][1][44][0]
[09] ADD      [506][44][100][1][44][0]
[10] FORLOOP  [506][45][100][1][45][0]
[06] MOD      [506][45][100][1][45][1]
[07] EQ       [506][45][100][1][45][1]
[08] JMP      [506][45][100][1][45][1]
[10] FORLOOP  [506][46][100][1][46][1]
[06] MOD      [506][46][100][1][46][0]
[07] EQ       [506][46][100][1][46][0]
[09] ADD      [552][46][100][1][46][0]
[10] FORLOOP  [552][47][100][1][47][0]
[06] MOD      [552][47][100][1][47][1]
[07] EQ       [552][47][100][1][47][1]
[08] JMP      [552][47][100][1][47][1]
[10] FORLOOP  [552][48][100][1][48][1]
[06] MOD      [552][48][100][1][48][0]
[07] EQ       [552][48][100][1][48][0]
[09] ADD      [600][48][100][1][48][0]
[10] FORLOOP  [600][49][100][1][49][0]
[06] MOD      [600][49][100][1][49][1]
[07] EQ       [600][49][100][1][49][1]
[08] JMP      [600][49][100][1][49][1]
[10] FORLOOP  [600][50][100][1][50][1]
[06] MOD      [600][50][100][1][50][0]
[07] EQ       [600][50][100][1][50][0]
[09] ADD      [650][50][100][1][50][0]
[10] FORLOOP  [650][51][100][1][51][0]
[06] MOD      [650][51][100][1][51][1]
[07] EQ       [650][51][100][1][51][1]
[08] JMP      [650][51][100][1][51][1]
[10] FORLOOP  [650][52][100][1][52][1]
[06] MOD      [650][52][100][1][52][0]
[07] EQ       [650][52][100][1][52][0]
[09] ADD      [702][52][100][1][52][0]
[10] FORLOOP  [702][53][100][1][53][0]
[06] MOD      [702][53][100][1][53][1]
[07] EQ       [702][53][100][1][53][1]
[08] JMP      [702][53][100][1][53][1]
[10] FORLOOP  [702][54][100][1][54][1]
[06] MOD      [702][54][100][1][54][0]
[07] EQ       [702][54][100][1][54][0]
[09] ADD      [756][54][100][1][54][0]
[10] FORLOOP  [756][55][100][1][55][0]
[06] MOD      [756][55][100][1][55][1]
[07] EQ       [756][55][100][1][55][1]
[08] JMP      [756][55][100][1][55][1]
[10] FORLOOP  [756][56][100][1][56][1]
[06] MOD      [756][56][100][1][56][0]
[07] EQ       [756][56][100][1][56][0]
[09] ADD      [812][56][100][1][56][0]
[10] FORLOOP  [812][57][100][1][57][0]
[06] MOD      [812][57][100][1][57][1]
[07] EQ       [812][57][100][1][57][1]
[08] JMP      [812][57][100][1][57][1]
[10] FORLOOP  [812][58][100][1][58][1]
[06] MOD      [812][58][100][1][58][0]
[07] EQ       [812][58][100][1][58][0]
[09] ADD      [870][58][100][1][58][0]
[10] FORLOOP  [870][59][100][1][59][0]
[06] MOD      [870][59][100][1][59][1]
[07] EQ       [870][59][100][1][59][1]
[08] JMP      [870][59][100][1][59][1]
[10] FORLOOP  [870][60][100][1][60][1]
[06] MOD      [870][60][100][1][60][0]
[07] EQ       [870][60][100][1][60][0]
[09] ADD      [930][60][100][1][60][0]
[10] FORLOOP  [930][61][100][1][61][0]
[06] MOD      [930][61][100][1][61][1]
[07] EQ       [930][61][100][1][61][1]
[08] JMP      [930][61][100][1][61][1]
[10] FORLOOP  [930][62][100][1][62][1]
[06] MOD      [930][62][100][1][62][0]
[07] EQ       [930][62][100][1][62][0]
[09] ADD      [992][62][100][1][62][0]
[10] FORLOOP  [992][63][100][1][63][0]
[06] MOD      [992][63][100][1][63][1]
[07] EQ       [992][63][100][1][63][1]
[08] JMP      [992][63][100][1][63][1]
[10] FORLOOP  [992][64][100][1][64][1]
[06] MOD      [992][64][100][1][64][0]
[07] EQ       [992][64][100][1][64][0]
[09] ADD      [1056][64][100][1][64][0]
[10] FORLOOP  [1056][65][100][1][65][0]
[06] MOD      [1056][65][100][1][65][1]
[07] EQ       [1056][65][100][1][65][1]
[08] JMP      [1056][65][100][1][65][1]
[10] FORLOOP  [1056][66][100][1][66][1]
[06] MOD      [1056][66][100][1][66][0]
[07] EQ       [1056][66][100][1][66][0]
[09] ADD      [1122][66][100][1][66][0]
[10] FORLOOP  [1122][67][100][1][67][0]
[06] MOD      [1122][67][100][1][67][1]
[07] EQ       [1122][67][100][1][67][1]
[08] JMP      [1122][67][100][1][67][1]
[10] FORLOOP  [1122][68][100][1][68][1]
[06] MOD      [1122][68][100][1][68][0]
[07] EQ       [1122][68][100][1][68][0]
[09] ADD      [1190][68][100][1][68][0]
[10] FORLOOP  [1190][69][100][1][69][0]
[06] MOD      [1190][69][100][1][69][1]
[07] EQ       [1190][69][100][1][69][1]
[08] JMP      [1190][69][100][1][69][1]
[10] FORLOOP  [1190][70][100][1][70][1]
[06] MOD      [1190][70][100][1][70][0]
[07] EQ       [1190][70][100][1][70][0]
[09] ADD      [1260][70][100][1][70][0]
[10] FORLOOP  [1260][71][100][1][71][0]
[06] MOD      [1260][71][100][1][71][1]
[07] EQ       [1260][71][100][1][71][1]
[08] JMP      [1260][71][100][1][71][1]
[10] FORLOOP  [1260][72][100][1][72][1]
[06] MOD      [1260][72][100][1][72][0]
[07] EQ       [1260][72][100][1][72][0]
[09] ADD      [1332][72][100][1][72][0]
[10] FORLOOP  [1332][73][100][1][73][0]
[06] MOD      [1332][73][100][1][73][1]
[07] EQ       [1332][73][100][1][73][1]
[08] JMP      [1332][73][100][1][73][1]
[10] FORLOOP  [1332][74][100][1][74][1]
[06] MOD      [1332][74][100][1][74][0]
[07] EQ       [1332][74][100][1][74][0]
[09] ADD      [1406][74][100][1][74][0]
[10] FORLOOP  [1406][75][100][1][75][0]
[06] MOD      [1406][75][100][1][75][1]
[07] EQ       [1406][75][100][1][75][1]
[08] JMP      [1406][75][100][1][75][1]
[10] FORLOOP  [1406][76][100][1][76][1]
[06] MOD      [1406][76][100][1][76][0]
[07] EQ       [1406][76][100][1][76][0]
[09] ADD      [1482][76][100][1][76][0]
[10] FORLOOP  [1482][77][100][1][77][0]
[06] MOD      [1482][77][100][1][77][1]
[07] EQ       [1482][77][100][1][77][1]
[08] JMP      [1482][77][100][1][77][1]
[10] FORLOOP  [1482][78][100][1][78][1]
[06] MOD      [1482][78][100][1][78][0]
[07] EQ       [1482][78][100][1][78][0]
[09] ADD      [1560][78][100][1][78][0]
[10] FORLOOP  [1560][79][100][1][79][0]
[06] MOD      [1560][79][100][1][79][1]
[07] EQ       [1560][79][100][1][79][1]
[08] JMP      [1560][79][100][1][79][1]
[10] FORLOOP  [1560][80][100][1][80][1]
[06] MOD      [1560][80][100][1][80][0]
[07] EQ       [1560][80][100][1][80][0]
[09] ADD      [1640][80][100][1][80][0]
[10] FORLOOP  [1640][81][100][1][81][0]
[06] MOD      [1640][81][100][1][81][1]
[07] EQ       [1640][81][100][1][81][1]
[08] JMP      [1640][81][100][1][81][1]
[10] FORLOOP  [1640][82][100][1][82][1]
[06] MOD      [1640][82][100][1][82][0]
[07] EQ       [1640][82][100][1][82][0]
[09] ADD      [1722][82][100][1][82][0]
[10] FORLOOP  [1722][83][100][1][83][0]
[06] MOD      [1722][83][100][1][83][1]
[07] EQ       [1722][83][100][1][83][1]
[08] JMP      [1722][83][100][1][83][1]
[10] FORLOOP  [1722][84][100][1][84][1]
[06] MOD      [1722][84][100][1][84][0]
[07] EQ       [1722][84][100][1][84][0]
[09] ADD      [1806][84][100][1][84][0]
[10] FORLOOP  [1806][85][100][1][85][0]
[06] MOD      [1806][85][100][1][85][1]
[07] EQ       [1806][85][100][1][85][1]
[08] JMP      [1806][85][100][1][85][1]
[10] FORLOOP  [1806][86][100][1][86][1]
[06] MOD      [1806][86][100][1][86][0]
[07] EQ       [1806][86][100][1][86][0]
[09] ADD      [1892][86][100][1][86][0]
[10] FORLOOP  [1892][87][100][1][87][0]
[06] MOD      [1892][87][100][1][87][1]
[07] EQ       [1892][87][100][1][87][1]
[08] JMP      [1892][87][100][1][87][1]
[10] FORLOOP  [1892][88][100][1][88][1]
[06] MOD      [1892][88][100][1][88][0]
[07] EQ       [1892][88][100][1][88][0]
[09] ADD      [1980][88][100][1][88][0]
[10] FORLOOP  [1980][89][100][1][89][0]
[06] MOD      [1980][89][100][1][89][1]
[07] EQ       [1980][89][100][1][89][1]
[08] JMP      [1980][89][100][1][89][1]
[10] FORLOOP  [1980][90][100][1][90][1]
[06] MOD      [1980][90][100][1][90][0]
[07] EQ       [1980][90][100][1][90][0]
[09] ADD      [2070][90][100][1][90][0]
[10] FORLOOP  [2070][91][100][1][91][0]
[06] MOD      [2070][91][100][1][91][1]
[07] EQ       [2070][91][100][1][91][1]
[08] JMP      [2070][91][100][1][91][1]
[10] FORLOOP  [2070][92][100][1][92][1]
[06] MOD      [2070][92][100][1][92][0]
[07] EQ       [2070][92][100][1][92][0]
[09] ADD      [2162][92][100][1][92][0]
[10] FORLOOP  [2162][93][100][1][93][0]
[06] MOD      [2162][93][100][1][93][1]
[07] EQ       [2162][93][100][1][93][1]
[08] JMP      [2162][93][100][1][93][1]
[10] FORLOOP  [2162][94][100][1][94][1]
[06] MOD      [2162][94][100][1][94][0]
[07] EQ       [2162][94][100][1][94][0]
[09] ADD      [2256][94][100][1][94][0]
[10] FORLOOP  [2256][95][100][1][95][0]
[06] MOD      [2256][95][100][1][95][1]
[07] EQ       [2256][95][100][1][95][1]
[08] JMP      [2256][95][100][1][95][1]
[10] FORLOOP  [2256][96][100][1][96][1]
[06] MOD      [2256][96][100][1][96][0]
[07] EQ       [2256][96][100][1][96][0]
[09] ADD      [2352][96][100][1][96][0]
[10] FORLOOP  [2352][97][100][1][97][0]
[06] MOD      [2352][97][100][1][97][1]
[07] EQ       [2352][97][100][1][97][1]
[08] JMP      [2352][97][100][1][97][1]
[10] FORLOOP  [2352][98][100][1][98][1]
[06] MOD      [2352][98][100][1][98][0]
[07] EQ       [2352][98][100][1][98][0]
[09] ADD      [2450][98][100][1][98][0]
[10] FORLOOP  [2450][99][100][1][99][0]
[06] MOD      [2450][99][100][1][99][1]
[07] EQ       [2450][99][100][1][99][1]
[08] JMP      [2450][99][100][1][99][1]
[10] FORLOOP  [2450][100][100][1][100][1]
[06] MOD      [2450][100][100][1][100][0]
[07] EQ       [2450][100][100][1][100][0]
[09] ADD      [2550][100][100][1][100][0]
[10] FORLOOP  [2550][101][100][1][100][0]
Process exiting with code: 0

*/
